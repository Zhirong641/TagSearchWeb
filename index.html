<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Tag Image Search</title>
    <div id="infoBox" class="info-box" style="display:none; position:absolute;"></div>
    <style>
        input, button { font-size: 18px; padding: 5px; }
        .suggestions { border: 1px solid #ccc; max-height: 150px; overflow-y: auto; }
        .suggestions div { padding: 4px; cursor: pointer; }
        .suggestions div:hover { background: #eee; }
        .info-box {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #ccc;
            padding: 8px;
            font-size: 14px;
            color: #333;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            max-width: 300px;
            max-height: none;
            overflow: visible;
            pointer-events: none;
            white-space: normal;
            word-break: break-word;
        }
    </style>
</head>
<body>
    <div style="background:#f5f5f5; padding:10px; border-bottom:1px solid #ccc;">
    ðŸ”— 
        <a href="https://github.com/Zhirong641/TagSearchWeb" target="_blank" style="margin-right:20px;">
        Project Source (GitHub)
        </a>
        ðŸ“˜ 
        <a href="https://github.com/Zhirong641/TagSearchWeb/blob/master/data/all_tags_translated_250722.csv" target="_blank">
        Tag List
        </a>
    </div>
    <h1>Enter Tags:</h1>
    <input id="tagInput" type="text" autocomplete="off">
    <div id="suggestions" class="suggestions"></div>
    <br><br>
    <button onclick="searchImage()">Search</button>
    <div id="result" style="margin-top:20px;"></div>
    <div id="infoBox" class="info-box" style="display:none; position:absolute;"></div>

    <script>
        let tagBox = document.getElementById('tagInput');
        let suggestionBox = document.getElementById('suggestions');

        tagBox.addEventListener('input', () => {
            let all = tagBox.value.split(/[,ï¼Œ ]+/);
            let last = all[all.length - 1].trim();

            if (last === "") {
                suggestionBox.innerHTML = "";
                return;
            }

            fetch('/tags?filter=' + encodeURIComponent(last))
                .then(res => res.json())
                .then(data => {
                    suggestionBox.innerHTML = "";
                    data.forEach(tag => {
                        let div = document.createElement('div');
                        div.textContent = tag;
                        div.onclick = () => {
                            all[all.length - 1] = tag;
                            tagBox.value = all.join(', ') + ', ';
                            suggestionBox.innerHTML = "";
                        };
                        suggestionBox.appendChild(div);
                    });
                });
        });

        function generateImage() {
            const tags = document.getElementById('tagInput').value.trim();
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>Generating, please wait...</p>';

            fetch('/validate', {
                method: 'POST',
                body: tags,
                headers: {
                    'Content-Type': 'text/plain'
                }
            }).then(res => {
                if (!res.ok) {
                    return res.text().then(msg => {
                        alert(msg);
                        resultDiv.innerHTML = '<p style="color:red;">' + msg + '</p>';
                        throw new Error("Invalid tags");
                    });
                } else {
                    return res.text();
                }
            }).then(() => {
                fetch('/generate_image', {
                    method: 'POST',
                    body: JSON.stringify({ tags: tags }),
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(res => {
                    if (!res.ok) {
                        return res.text().then(msg => {
                            resultDiv.innerHTML = '<p style="color:red;">Generation failed: ' + msg + '</p>';
                            throw new Error("Generation failed");
                        });
                    }
                    return res.blob();
                })
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    resultDiv.innerHTML =
                        `<h2>Generation Complete (Tags: ${tags})</h2><img src="${url}" width="512">`;
                })
            }).catch((err) => {
                console.log(err);
            });
        }

        function searchImage() {
            const tags = document.getElementById('tagInput').value.trim();
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>Searching, please wait...</p>';

            fetch('/search', {
                    method: 'POST',
                    body: JSON.stringify({ tags: tags }),
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(res => {
                    if (!res.ok) {
                        return res.text().then(msg => {
                            resultDiv.innerHTML = '<p style="color:red;">Search failed: ' + msg + '</p>';
                            throw new Error("Search failed");
                        });
                    }
                    return res.json();
                })
                .then(data => {
                    const images = data.images || [];

                    if (images.length === 0) {
                        resultDiv.innerHTML = '<p>No related images found.</p>';
                        return;
                    }

                    const pageSize = 100;
                    let currentPage = 1;

                    function renderPage(page) {
                        const start = (page - 1) * pageSize;
                        const end = Math.min(start + pageSize, images.length);
                        const pageData = images.slice(start, end);

                        let html = `<h2>Search Results (Page ${page} of ${Math.ceil(images.length / pageSize)})</h2>`;
                        html += '<div style="display:flex;flex-wrap:wrap;">';

                        pageData.forEach(filename => {
                            html += `
                                <div style="margin:10px;text-align:center">
                                    <a href="/img/${filename}" target="_blank">
                                        <img src="/img/${filename}" width="200" onmouseover="loadImageInfoAtCursor(event, '${filename}')" onmouseout="hideInfo()">
                                    </a><br>
                                    ${filename}
                                </div>
                            `;
                        });

                        html += '</div><div style="margin-top:20px;">';

                        // Previous page button
                        if (page > 1) {
                            html += `<button onclick="changePage(${page - 1})">Previous</button> `;
                        }

                        // Page number buttons
                        const totalPages = Math.ceil(images.length / pageSize);
                        for (let i = 1; i <= totalPages; i++) {
                            if (i === page) {
                                html += `<strong style="margin:0 5px;">[${i}]</strong>`;
                            } else {
                                html += `<a href="javascript:void(0);" onclick="changePage(${i})" style="margin:0 5px;">${i}</a>`;
                            }
                        }

                        // Next page button
                        if (page < totalPages) {
                            html += ` <button onclick="changePage(${page + 1})">Next</button>`;
                        }

                        html += '</div>';

                        resultDiv.innerHTML = html;
                    }

                    window.changePage = function (page) {
                        currentPage = page;
                        renderPage(currentPage);
                    }

                    renderPage(currentPage);
                })
                .catch(err => {
                    console.error(err);
                    if (!resultDiv.innerHTML.includes('Search failed')) {
                        resultDiv.innerHTML = '<p style="color:red;">Search failed, please try again later.</p>';
                    }
                });
        }

        function loadImageInfo(img, filename) {
            const info = document.getElementById('infoBox');
            info.innerHTML = 'Loading...';
            info.style.display = 'block';

            const rect = img.getBoundingClientRect();
            info.style.left = (rect.right + 10) + 'px';
            info.style.top = rect.top + 'px';

            fetch(`/image_info?file=${encodeURIComponent(filename)}`)
                .then(res => res.ok ? res.text() : Promise.reject('Unable to get info'))
                .then(text => {
                    info.innerHTML = text;
                })
                .catch(err => {
                    info.innerHTML = `<span style="color:red;">Load failed</span>`;
                    console.error(err);
                });
        }
    
       function loadImageInfoAtCursor(e, filename) {
            const info = document.getElementById('infoBox');

            if (!info.dataset.filename || info.dataset.filename !== filename) {
                info.innerHTML = 'Loading...';
                info.dataset.filename = filename;

                fetch(`/image_info?file=${encodeURIComponent(filename)}`)
                    .then(res => res.ok ? res.text() : Promise.reject('Unable to get info'))
                    .then(text => {
                        if (info.dataset.filename === filename) {
                            info.innerHTML = text;
                        }
                    })
                    .catch(err => {
                        info.innerHTML = `<span style="color:red;">Load failed</span>`;
                        console.error(err);
                    });
            }

            info.style.display = 'block';
            info.style.left = '0px';
            info.style.top = '0px';

            const tooltipWidth = info.offsetWidth;
            const tooltipHeight = info.offsetHeight;
            const pageWidth = document.documentElement.clientWidth;
            const pageHeight = document.documentElement.clientHeight;

            let left = e.pageX + 15;
            let top = e.pageY + 15;

            if (left + tooltipWidth > pageWidth) {
                left = e.pageX - tooltipWidth - 15;
            }

            if (top + tooltipHeight > pageHeight + window.scrollY) {
                top = e.pageY - tooltipHeight - 15;
            }

            info.style.left = left + 'px';
            info.style.top = top + 'px';
        }

        function hideInfo() {
            const info = document.getElementById('infoBox');
            info.style.display = 'none';
        }
    </script>
</body>
</html>
