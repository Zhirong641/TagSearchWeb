<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>æ ‡ç­¾å›¾åƒç”Ÿæˆ</title>
    <div id="infoBox" class="info-box" style="display:none; position:absolute;"></div>
    <style>
        input, button { font-size: 18px; padding: 5px; }
        .suggestions { border: 1px solid #ccc; max-height: 150px; overflow-y: auto; }
        .suggestions div { padding: 4px; cursor: pointer; }
        .suggestions div:hover { background: #eee; }
        .info-box {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #ccc;
            padding: 8px;
            font-size: 14px;
            color: #333;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            max-width: 300px;
            /* âœ… å»æ‰æ»šåŠ¨æ¡é™åˆ¶ */
            max-height: none;
            overflow: visible;
            pointer-events: none;
            white-space: normal;  /* å…è®¸è‡ªåŠ¨æ¢è¡Œ */
            word-break: break-word;
        }
    </style>
</head>
<body>
    <div style="background:#f5f5f5; padding:10px; border-bottom:1px solid #ccc;">
    ğŸ”— 
    <a href="https://github.com/Zhirong641/TagSearchWeb" target="_blank" style="margin-right:20px;">
      é¡¹ç›®æºç ï¼ˆGitHubï¼‰
    </a>
    ğŸ“˜ 
    <a href="http://198.13.48.172/resource/tag_statistics/" target="_blank">
      Tagåˆ—è¡¨
    </a>
  </div>
    <h1>è¾“å…¥æ ‡ç­¾ï¼š</h1>
    <input id="tagInput" type="text" autocomplete="off">
    <div id="suggestions" class="suggestions"></div>
    <br><br>
    <button onclick="searchImage()">æœç´¢</button>
    <div id="result" style="margin-top:20px;"></div>
    <div id="infoBox" class="info-box" style="display:none; position:absolute;"></div>

    <script>
        let tagBox = document.getElementById('tagInput');
        let suggestionBox = document.getElementById('suggestions');

        tagBox.addEventListener('input', () => {
            let all = tagBox.value.split(/[,ï¼Œ ]+/);
            let last = all[all.length - 1].trim();

            if (last === "") {
                suggestionBox.innerHTML = "";
                return;
            }

            fetch('/tags?filter=' + encodeURIComponent(last))
                .then(res => res.json())
                .then(data => {
                    suggestionBox.innerHTML = "";
                    data.forEach(tag => {
                        let div = document.createElement('div');
                        div.textContent = tag;
                        div.onclick = () => {
                            all[all.length - 1] = tag; // æ›¿æ¢æœ€åä¸€ä¸ª
                            tagBox.value = all.join(', ') + ', ';
                            suggestionBox.innerHTML = "";
                        };
                        suggestionBox.appendChild(div);
                    });
                });
        });

        function generateImage() {
            const tags = document.getElementById('tagInput').value.trim();
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...</p>';

            // å…ˆéªŒè¯æ ‡ç­¾åˆæ³•æ€§
            fetch('/validate', {
                method: 'POST',
                body: tags,
                headers: {
                    'Content-Type': 'text/plain'
                }
            }).then(res => {
                if (!res.ok) {
                    return res.text().then(msg => {
                        alert(msg);
                        resultDiv.innerHTML = '<p style="color:red;">' + msg + '</p>';
                        throw new Error("æ ‡ç­¾ä¸åˆæ³•");
                    });
                } else {
                    return res.text();
                }
            }).then(() => {
                // æ¨¡æ‹Ÿç”Ÿæˆè€—æ—¶ï¼ˆ1ç§’ï¼‰ï¼ŒçœŸå®æƒ…å†µä½ å¯ä»¥æ›¿æ¢æˆç”Ÿæˆè¯·æ±‚æˆ–è½®è¯¢
                // setTimeout(() => {
                //     resultDiv.innerHTML =
                //         '<h2>ç”Ÿæˆç»“æœï¼ˆæ ‡ç­¾ï¼š' + tags + 'ï¼‰ï¼š</h2><img src="/sample.png" width="512">';
                // }, 3000);
                fetch('/generate_image', {
                    method: 'POST',
                    body: JSON.stringify({ tags: tags }),
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(res => {
                    if (!res.ok) {
                        return res.text().then(msg => {
                            resultDiv.innerHTML = '<p style="color:red;">ç”Ÿæˆå¤±è´¥ï¼š' + msg + '</p>';
                            throw new Error("ç”Ÿæˆå¤±è´¥");
                        });
                    }
                    return res.blob();
                })
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    resultDiv.innerHTML =
                        `<h2>ç”Ÿæˆå®Œæˆï¼ˆæ ‡ç­¾ï¼š${tags}ï¼‰</h2><img src="${url}" width="512">`;
                })
            }).catch((err) => {
                console.log(err);
            });
        }

        function searchImage() {
            const tags = document.getElementById('tagInput').value.trim();
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>æ­£åœ¨æœç´¢ä¸­ï¼Œè¯·ç¨å€™...</p>';

            fetch('/search', {
                    method: 'POST',
                    body: JSON.stringify({ tags: tags }),
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(res => {
                    if (!res.ok) {
                        return res.text().then(msg => {
                            resultDiv.innerHTML = '<p style="color:red;">æœç´¢å¤±è´¥ï¼š' + msg + '</p>';
                            throw new Error("æœç´¢å¤±è´¥");
                        });
                    }
                    return res.json();
                })
                .then(data => {
                    const images = data.images || [];

                    if (images.length === 0) {
                        resultDiv.innerHTML = '<p>æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å›¾åƒã€‚</p>';
                        return;
                    }

                    const pageSize = 100;
                    let currentPage = 1;

                    function renderPage(page) {
                        const start = (page - 1) * pageSize;
                        const end = Math.min(start + pageSize, images.length);
                        const pageData = images.slice(start, end);

                        let html = `<h2>æœç´¢ç»“æœï¼ˆç¬¬ ${page} é¡µï¼Œå…± ${Math.ceil(images.length / pageSize)} é¡µï¼‰</h2>`;
                        html += '<div style="display:flex;flex-wrap:wrap;">';

                        pageData.forEach(filename => {
                            html += `
                                <div style="margin:10px;text-align:center">
                                    <a href="/img/${filename}" target="_blank">
                                        <img src="/img/${filename}" width="200" onmouseover="loadImageInfoAtCursor(event, '${filename}')" onmouseout="hideInfo()">
                                    </a><br>
                                    ${filename}
                                </div>
                            `;
                        });

                        html += '</div><div style="margin-top:20px;">';

                        // ä¸Šä¸€é¡µæŒ‰é’®
                        if (page > 1) {
                            html += `<button onclick="changePage(${page - 1})">ä¸Šä¸€é¡µ</button> `;
                        }

                        // é¡µç æŒ‰é’®
                        const totalPages = Math.ceil(images.length / pageSize);
                        for (let i = 1; i <= totalPages; i++) {
                            if (i === page) {
                                html += `<strong style="margin:0 5px;">[${i}]</strong>`;
                            } else {
                                html += `<a href="javascript:void(0);" onclick="changePage(${i})" style="margin:0 5px;">${i}</a>`;
                            }
                        }

                        // ä¸‹ä¸€é¡µæŒ‰é’®
                        if (page < totalPages) {
                            html += ` <button onclick="changePage(${page + 1})">ä¸‹ä¸€é¡µ</button>`;
                        }

                        html += '</div>';

                        resultDiv.innerHTML = html;
                    }

                    // å®šä¹‰ç¿»é¡µå‡½æ•°åˆ°å…¨å±€
                    window.changePage = function (page) {
                        currentPage = page;
                        renderPage(currentPage);
                    }

                    // åˆæ¬¡æ¸²æŸ“ç¬¬ä¸€é¡µ
                    renderPage(currentPage);
                })
                .catch(err => {
                    console.error(err);
                    if (!resultDiv.innerHTML.includes('æœç´¢å¤±è´¥')) {
                        resultDiv.innerHTML = '<p style="color:red;">æœç´¢å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚</p>';
                    }
                });
        }

        function loadImageInfo(img, filename) {
            const info = document.getElementById('infoBox');
            info.innerHTML = 'åŠ è½½ä¸­...';
            info.style.display = 'block';

            const rect = img.getBoundingClientRect();
            info.style.left = (rect.right + 10) + 'px';
            info.style.top = rect.top + 'px';

            fetch(`/image_info?file=${encodeURIComponent(filename)}`)
                .then(res => res.ok ? res.text() : Promise.reject('æ— æ³•è·å–ä¿¡æ¯'))
                .then(text => {
                    info.innerHTML = text;
                })
                .catch(err => {
                    info.innerHTML = `<span style="color:red;">åŠ è½½å¤±è´¥</span>`;
                    console.error(err);
                });
        }
    
       function loadImageInfoAtCursor(e, filename) {
            const info = document.getElementById('infoBox');

            // åªè¯·æ±‚ä¸€æ¬¡
            if (!info.dataset.filename || info.dataset.filename !== filename) {
                info.innerHTML = 'åŠ è½½ä¸­...';
                info.dataset.filename = filename;

                fetch(`/image_info?file=${encodeURIComponent(filename)}`)
                    .then(res => res.ok ? res.text() : Promise.reject('æ— æ³•è·å–ä¿¡æ¯'))
                    .then(text => {
                        if (info.dataset.filename === filename) {
                            info.innerHTML = text;
                        }
                    })
                    .catch(err => {
                        info.innerHTML = `<span style="color:red;">åŠ è½½å¤±è´¥</span>`;
                        console.error(err);
                    });
            }

            // æš‚æ—¶æ˜¾ç¤ºä»¥è®¡ç®—å®½é«˜
            info.style.display = 'block';
            info.style.left = '0px';
            info.style.top = '0px'; // åˆå§‹ä½ç½®é˜²æ­¢é—ªåŠ¨

            const tooltipWidth = info.offsetWidth;
            const tooltipHeight = info.offsetHeight;
            const pageWidth = document.documentElement.clientWidth;
            const pageHeight = document.documentElement.clientHeight;

            let left = e.pageX + 15;
            let top = e.pageY + 15;

            // å¦‚æœå³è¾¹æ”¾ä¸ä¸‹å°±æ˜¾ç¤ºåœ¨å·¦è¾¹
            if (left + tooltipWidth > pageWidth) {
                left = e.pageX - tooltipWidth - 15;
            }

            // å¦‚æœåº•éƒ¨æ”¾ä¸ä¸‹å°±æ˜¾ç¤ºåœ¨ä¸Šæ–¹
            if (top + tooltipHeight > pageHeight + window.scrollY) {
                top = e.pageY - tooltipHeight - 15;
            }

            // è®¾ç½®ä½ç½®
            info.style.left = left + 'px';
            info.style.top = top + 'px';
        }

        function hideInfo() {
            const info = document.getElementById('infoBox');
            info.style.display = 'none';
        }
    </script>
</body>
</html>